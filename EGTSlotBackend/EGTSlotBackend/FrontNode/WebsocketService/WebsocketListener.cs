using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using Akka.Actor;
using Akka.Configuration;
using System.Net;
using System.Threading;
using Akka.Event;
using System.Net.WebSockets;
using Newtonsoft.Json.Linq;
using System.Runtime.Remoting.Contexts;

namespace FrontNode.WebsocketService
{
    public class WebsocketListener : ReceiveActor
    {
        private string              _listenURL;
        private int                 _acceptLimit;
        private Task[]              _acceptTasks;
        private IActorRef           _dbReader;
        private System.Net.HttpListener        _httpListener = null;
        private string              _jackpotstatsDummyData = "{\r\n  \"jackpotCards\": {\r\n    \"currency\": \"FUN\",\r\n    \"currentLevelI\": 5000,\r\n    \"winsLevelI\": 22646,\r\n    \"largestWinLevelI\": 11519320,\r\n    \"largestWinDateLevelI\": \"2024-11-25T19:30:41.085Z\",\r\n    \"largestWinUserLevelI\": \"sl_playerDemo Player - 1384677064707\",\r\n    \"lastWinLevelI\": 1900272,\r\n    \"lastWinDateLevelI\": \"2025-07-21T06:41:19.126Z\",\r\n    \"lastWinUserLevelI\": \"sl_playerDemo Player - 1468713332737\",\r\n    \"lastWinnersLevelI\": [\r\n      {\r\n        \"winUser\": \"sl_playerDemo Player - 1468713332737\",\r\n        \"winAmount\": 1900272,\r\n        \"winDate\": \"2025-07-21T06:41:19.126Z\",\r\n        \"gin\": \"412\",\r\n        \"winLevel\": \"0\"\r\n      },\r\n      {\r\n        \"winUser\": \"sl_playerDemo Player - 1468659679233\",\r\n        \"winAmount\": 2965018,\r\n        \"winDate\": \"2025-07-21T03:19:03.992Z\",\r\n        \"gin\": \"831\",\r\n        \"winLevel\": \"0\"\r\n      },\r\n      {\r\n        \"winUser\": \"sl_playerDemo Player - 1468608425986\",\r\n        \"winAmount\": 2174430,\r\n        \"winDate\": \"2025-07-20T23:28:31.453Z\",\r\n        \"gin\": \"5000\",\r\n        \"winLevel\": \"0\"\r\n      },\r\n      {\r\n        \"winUser\": \"sl_playerDemo Player - 1468586610691\",\r\n        \"winAmount\": 1662702,\r\n        \"winDate\": \"2025-07-20T21:41:26.402Z\",\r\n        \"gin\": \"568\",\r\n        \"winLevel\": \"0\"\r\n      },\r\n      {\r\n        \"winUser\": \"sl_playerDemo Player - 1468568817666\",\r\n        \"winAmount\": 1614120,\r\n        \"winDate\": \"2025-07-20T20:20:52.879Z\",\r\n        \"gin\": \"529\",\r\n        \"winLevel\": \"0\"\r\n      }\r\n    ],\r\n    \"topMonthlyWinnersLevelI\": [\r\n      {\r\n        \"winUser\": \"sl_playerDemo Player - 1465106337793\",\r\n        \"winAmount\": 6606974,\r\n        \"winDate\": \"2025-07-11T02:30:42.021Z\",\r\n        \"gin\": \"803\",\r\n        \"winLevel\": \"0\"\r\n      },\r\n      {\r\n        \"winUser\": \"sl_playerDemo Player - 1463745466369\",\r\n        \"winAmount\": 5514700,\r\n        \"winDate\": \"2025-07-07T05:24:16.256Z\",\r\n        \"gin\": \"511\",\r\n        \"winLevel\": \"0\"\r\n      },\r\n      {\r\n        \"winUser\": \"sl_playerDemo Player - 1467365249029\",\r\n        \"winAmount\": 5391259,\r\n        \"winDate\": \"2025-07-17T10:44:46.132Z\",\r\n        \"gin\": \"566\",\r\n        \"winLevel\": \"0\"\r\n      },\r\n      {\r\n        \"winUser\": \"sl_playerDemo Player - 1466738331649\",\r\n        \"winAmount\": 5314850,\r\n        \"winDate\": \"2025-07-15T16:26:02.119Z\",\r\n        \"gin\": \"5085\",\r\n        \"winLevel\": \"0\"\r\n      },\r\n      {\r\n        \"winUser\": \"sl_playerDemo Player - 1462823956483\",\r\n        \"winAmount\": 5177801,\r\n        \"winDate\": \"2025-07-04T14:44:16.681Z\",\r\n        \"gin\": \"632\",\r\n        \"winLevel\": \"0\"\r\n      }\r\n    ],\r\n    \"topYearlyWinnersLevelI\": [\r\n      {\r\n        \"winUser\": \"sl_playerDemo Player - 1417928007683\",\r\n        \"winAmount\": 8879292,\r\n        \"winDate\": \"2025-02-27T18:42:04.828Z\",\r\n        \"gin\": \"822\",\r\n        \"winLevel\": \"0\"\r\n      },\r\n      {\r\n        \"winUser\": \"sl_playerDemo Player - 1450447736834\",\r\n        \"winAmount\": 8876067,\r\n        \"winDate\": \"2025-05-30T15:30:57.383Z\",\r\n        \"gin\": \"529\",\r\n        \"winLevel\": \"0\"\r\n      },\r\n      {\r\n        \"winUser\": \"sl_playerDemo Player - 1430054617090\",\r\n        \"winAmount\": 8266841,\r\n        \"winDate\": \"2025-04-03T00:30:59.921Z\",\r\n        \"gin\": \"529\",\r\n        \"winLevel\": \"0\"\r\n      },\r\n      {\r\n        \"winUser\": \"sl_playerDemo Player - 1434615271427\",\r\n        \"winAmount\": 7679688,\r\n        \"winDate\": \"2025-04-15T21:45:49.106Z\",\r\n        \"gin\": \"555\",\r\n        \"winLevel\": \"0\"\r\n      },\r\n      {\r\n        \"winUser\": \"sl_playerDemo Player - 1449740537857\",\r\n        \"winAmount\": 7536505,\r\n        \"winDate\": \"2025-05-28T15:28:24.044Z\",\r\n        \"gin\": \"566\",\r\n        \"winLevel\": \"0\"\r\n      }\r\n    ],\r\n    \"currentLevelII\": 6308813,\r\n    \"winsLevelII\": 7495,\r\n    \"largestWinLevelII\": 43668967,\r\n    \"largestWinDateLevelII\": \"2024-11-16T12:57:21.648Z\",\r\n    \"largestWinUserLevelII\": \"player\",\r\n    \"lastWinLevelII\": 11460963,\r\n    \"lastWinDateLevelII\": \"2025-07-21T00:30:52.037Z\",\r\n    \"lastWinUserLevelII\": \"sl_playerDemo Player - 1468621221890\",\r\n    \"lastWinnersLevelII\": [\r\n      {\r\n        \"winUser\": \"sl_playerDemo Player - 1468621221890\",\r\n        \"winAmount\": 11460963,\r\n        \"winDate\": \"2025-07-21T00:30:52.037Z\",\r\n        \"gin\": \"405\",\r\n        \"winLevel\": \"1\"\r\n      },\r\n      {\r\n        \"winUser\": \"sl_playerDemo Player - 1468479475717\",\r\n        \"winAmount\": 6984548,\r\n        \"winDate\": \"2025-07-20T14:16:41.205Z\",\r\n        \"gin\": \"5000\",\r\n        \"winLevel\": \"1\"\r\n      },\r\n      {\r\n        \"winUser\": \"sl_playerDemo Player - 1468307861505\",\r\n        \"winAmount\": 5329605,\r\n        \"winDate\": \"2025-07-20T03:12:35.157Z\",\r\n        \"gin\": \"806\",\r\n        \"winLevel\": \"1\"\r\n      },\r\n      {\r\n        \"winUser\": \"sl_playerDemo Player - 1468248281089\",\r\n        \"winAmount\": 6338795,\r\n        \"winDate\": \"2025-07-19T22:35:52.053Z\",\r\n        \"gin\": \"5000\",\r\n        \"winLevel\": \"1\"\r\n      },\r\n      {\r\n        \"winUser\": \"sl_playerDemo Player - 1468178698245\",\r\n        \"winAmount\": 6641073,\r\n        \"winDate\": \"2025-07-19T17:56:10.674Z\",\r\n        \"gin\": \"806\",\r\n        \"winLevel\": \"1\"\r\n      }\r\n    ],\r\n    \"topMonthlyWinnersLevelII\": [\r\n      {\r\n        \"winUser\": \"sl_playerDemo Player - 1461748502534\",\r\n        \"winAmount\": 21996820,\r\n        \"winDate\": \"2025-07-01T14:16:16.985Z\",\r\n        \"gin\": \"19\",\r\n        \"winLevel\": \"1\"\r\n      },\r\n      {\r\n        \"winUser\": \"sl_playerDemo Player - 1465946402817\",\r\n        \"winAmount\": 18104927,\r\n        \"winDate\": \"2025-07-13T10:28:53.86Z\",\r\n        \"gin\": \"5082\",\r\n        \"winLevel\": \"1\"\r\n      },\r\n      {\r\n        \"winUser\": \"sl_playerDemo Player - 1465519403010\",\r\n        \"winAmount\": 14676911,\r\n        \"winDate\": \"2025-07-12T05:32:35.554Z\",\r\n        \"gin\": \"5000\",\r\n        \"winLevel\": \"1\"\r\n      },\r\n      {\r\n        \"winUser\": \"sl_playerDemo Player - 1467264069634\",\r\n        \"winAmount\": 13295559,\r\n        \"winDate\": \"2025-07-17T03:53:41.05Z\",\r\n        \"gin\": \"5085\",\r\n        \"winLevel\": \"1\"\r\n      },\r\n      {\r\n        \"winUser\": \"sl_playerDemo Player - 1462789058564\",\r\n        \"winAmount\": 12830032,\r\n        \"winDate\": \"2025-07-04T13:09:34.792Z\",\r\n        \"gin\": \"5000\",\r\n        \"winLevel\": \"1\"\r\n      }\r\n    ],\r\n    \"topYearlyWinnersLevelII\": [\r\n      {\r\n        \"winUser\": \"sl_playerDemo Player - 1412621127683\",\r\n        \"winAmount\": 32428516,\r\n        \"winDate\": \"2025-02-12T18:19:14.04Z\",\r\n        \"gin\": \"566\",\r\n        \"winLevel\": \"1\"\r\n      },\r\n      {\r\n        \"winUser\": \"sl_playerDemo Player - 1408234704903\",\r\n        \"winAmount\": 30301906,\r\n        \"winDate\": \"2025-01-31T08:53:56.454Z\",\r\n        \"gin\": \"801\",\r\n        \"winLevel\": \"1\"\r\n      },\r\n      {\r\n        \"winUser\": \"sl_playerDemo Player - 1417729564675\",\r\n        \"winAmount\": 28625973,\r\n        \"winDate\": \"2025-02-27T04:39:03.555Z\",\r\n        \"gin\": \"428\",\r\n        \"winLevel\": \"1\"\r\n      },\r\n      {\r\n        \"winUser\": \"sl_playerDemo Player - 1429524066307\",\r\n        \"winAmount\": 27434908,\r\n        \"winDate\": \"2025-04-01T13:37:01.443Z\",\r\n        \"gin\": \"527\",\r\n        \"winLevel\": \"1\"\r\n      },\r\n      {\r\n        \"winUser\": \"sl_playerDemo Player - 1417313611777\",\r\n        \"winAmount\": 26917501,\r\n        \"winDate\": \"2025-02-26T00:49:47.976Z\",\r\n        \"gin\": \"801\",\r\n        \"winLevel\": \"1\"\r\n      }\r\n    ],\r\n    \"currentLevelIII\": 126595752,\r\n    \"winsLevelIII\": 197,\r\n    \"largestWinLevelIII\": 1316734144,\r\n    \"largestWinDateLevelIII\": \"2025-01-13T19:44:49.571Z\",\r\n    \"largestWinUserLevelIII\": \"player\",\r\n    \"lastWinLevelIII\": 49280491,\r\n    \"lastWinDateLevelIII\": \"2025-07-15T05:05:53.468Z\",\r\n    \"lastWinUserLevelIII\": \"sl_playerDemo Player - 1466573742082\",\r\n    \"lastWinnersLevelIII\": [\r\n      {\r\n        \"winUser\": \"sl_playerDemo Player - 1466573742082\",\r\n        \"winAmount\": 49280491,\r\n        \"winDate\": \"2025-07-15T05:05:53.468Z\",\r\n        \"gin\": \"803\",\r\n        \"winLevel\": \"2\"\r\n      },\r\n      {\r\n        \"winUser\": \"sl_playerDemo Player - 1465937166338\",\r\n        \"winAmount\": 300197160,\r\n        \"winDate\": \"2025-07-13T09:51:32.546Z\",\r\n        \"gin\": \"566\",\r\n        \"winLevel\": \"2\"\r\n      },\r\n      {\r\n        \"winUser\": \"sl_playerDemo Player - 1465539416066\",\r\n        \"winAmount\": 717453464,\r\n        \"winDate\": \"2025-07-12T06:57:44.631Z\",\r\n        \"gin\": \"529\",\r\n        \"winLevel\": \"2\"\r\n      },\r\n      {\r\n        \"winUser\": \"sl_playerDemo Player - 1454603960328\",\r\n        \"winAmount\": 296853317,\r\n        \"winDate\": \"2025-06-11T09:20:33.725Z\",\r\n        \"gin\": \"5000\",\r\n        \"winLevel\": \"2\"\r\n      },\r\n      {\r\n        \"winUser\": \"sl_playerDemo Player - 1453580730375\",\r\n        \"winAmount\": 638505111,\r\n        \"winDate\": \"2025-06-08T12:02:10.897Z\",\r\n        \"gin\": \"5000\",\r\n        \"winLevel\": \"2\"\r\n      }\r\n    ],\r\n    \"topMonthlyWinnersLevelIII\": [\r\n      {\r\n        \"winUser\": \"sl_playerDemo Player - 1465539416066\",\r\n        \"winAmount\": 717453464,\r\n        \"winDate\": \"2025-07-12T06:57:44.631Z\",\r\n        \"gin\": \"529\",\r\n        \"winLevel\": \"2\"\r\n      },\r\n      {\r\n        \"winUser\": \"sl_playerDemo Player - 1465937166338\",\r\n        \"winAmount\": 300197160,\r\n        \"winDate\": \"2025-07-13T09:51:32.546Z\",\r\n        \"gin\": \"566\",\r\n        \"winLevel\": \"2\"\r\n      },\r\n      {\r\n        \"winUser\": \"sl_playerDemo Player - 1466573742082\",\r\n        \"winAmount\": 49280491,\r\n        \"winDate\": \"2025-07-15T05:05:53.468Z\",\r\n        \"gin\": \"803\",\r\n        \"winLevel\": \"2\"\r\n      }\r\n    ],\r\n    \"topYearlyWinnersLevelIII\": [\r\n      {\r\n        \"winUser\": \"player\",\r\n        \"winAmount\": 1316734144,\r\n        \"winDate\": \"2025-01-13T19:44:49.571Z\",\r\n        \"gin\": \"***\",\r\n        \"winLevel\": \"2\"\r\n      },\r\n      {\r\n        \"winUser\": \"sl_playerDemo Player - 1442731278342\",\r\n        \"winAmount\": 906851261,\r\n        \"winDate\": \"2025-05-08T20:07:13.421Z\",\r\n        \"gin\": \"592\",\r\n        \"winLevel\": \"2\"\r\n      },\r\n      {\r\n        \"winUser\": \"sl_playerDemo Player - 1465539416066\",\r\n        \"winAmount\": 717453464,\r\n        \"winDate\": \"2025-07-12T06:57:44.631Z\",\r\n        \"gin\": \"529\",\r\n        \"winLevel\": \"2\"\r\n      },\r\n      {\r\n        \"winUser\": \"sl_playerDemo Player - 1453580730375\",\r\n        \"winAmount\": 638505111,\r\n        \"winDate\": \"2025-06-08T12:02:10.897Z\",\r\n        \"gin\": \"5000\",\r\n        \"winLevel\": \"2\"\r\n      },\r\n      {\r\n        \"winUser\": \"player\",\r\n        \"winAmount\": 566484756,\r\n        \"winDate\": \"2025-01-18T05:38:59.762Z\",\r\n        \"gin\": \"558\",\r\n        \"winLevel\": \"2\"\r\n      }\r\n    ],\r\n    \"currentLevelIV\": 2621389313,\r\n    \"winsLevelIV\": 14,\r\n    \"largestWinLevelIV\": 7119677079,\r\n    \"largestWinDateLevelIV\": \"2024-11-17T01:47:32.764Z\",\r\n    \"largestWinUserLevelIV\": \"player\",\r\n    \"lastWinLevelIV\": 3740684980,\r\n    \"lastWinDateLevelIV\": \"2025-05-17T23:51:50.2Z\",\r\n    \"lastWinUserLevelIV\": \"sl_playerDemo Player - 1445911347203\",\r\n    \"lastWinnersLevelIV\": [\r\n      {\r\n        \"winUser\": \"sl_playerDemo Player - 1445911347203\",\r\n        \"winAmount\": 3740684980,\r\n        \"winDate\": \"2025-05-17T23:51:50.2Z\",\r\n        \"gin\": \"19\",\r\n        \"winLevel\": \"3\"\r\n      },\r\n      {\r\n        \"winUser\": \"sl_playerDemo Player - 1392325828610\",\r\n        \"winAmount\": 2246048268,\r\n        \"winDate\": \"2024-12-17T09:45:13.037Z\",\r\n        \"gin\": \"***\",\r\n        \"winLevel\": \"3\"\r\n      },\r\n      {\r\n        \"winUser\": \"sl_playerDemo Player - 1384869765121\",\r\n        \"winAmount\": 2256809427,\r\n        \"winDate\": \"2024-11-26T08:31:50.579Z\",\r\n        \"gin\": \"***\",\r\n        \"winLevel\": \"3\"\r\n      },\r\n      {\r\n        \"winUser\": \"sl_playerDemo Player - 1384584265734\",\r\n        \"winAmount\": 3399684871,\r\n        \"winDate\": \"2024-11-25T12:54:59.514Z\",\r\n        \"gin\": \"***\",\r\n        \"winLevel\": \"3\"\r\n      },\r\n      {\r\n        \"winUser\": \"sl_playerDemo Player - 1383965110279\",\r\n        \"winAmount\": 2774844405,\r\n        \"winDate\": \"2024-11-23T18:45:38.703Z\",\r\n        \"gin\": \"***\",\r\n        \"winLevel\": \"3\"\r\n      }\r\n    ],\r\n    \"topMonthlyWinnersLevelIV\": [],\r\n    \"topYearlyWinnersLevelIV\": [\r\n      {\r\n        \"winUser\": \"sl_playerDemo Player - 1445911347203\",\r\n        \"winAmount\": 3740684980,\r\n        \"winDate\": \"2025-05-17T23:51:50.2Z\",\r\n        \"gin\": \"19\",\r\n        \"winLevel\": \"3\"\r\n      }\r\n    ],\r\n    \"timestamp\": \"2025-07-21T08:45:53.212529054Z\",\r\n    \"lastWinners\": [\r\n      {\r\n        \"winUser\": \"sl_playerDemo Player - 1468713332737\",\r\n        \"winAmount\": 1900272,\r\n        \"winDate\": \"2025-07-21T06:41:19.126Z\",\r\n        \"gin\": \"412\",\r\n        \"winLevel\": \"0\"\r\n      },\r\n      {\r\n        \"winUser\": \"sl_playerDemo Player - 1468659679233\",\r\n        \"winAmount\": 2965018,\r\n        \"winDate\": \"2025-07-21T03:19:03.992Z\",\r\n        \"gin\": \"831\",\r\n        \"winLevel\": \"0\"\r\n      },\r\n      {\r\n        \"winUser\": \"sl_playerDemo Player - 1468621221890\",\r\n        \"winAmount\": 11460963,\r\n        \"winDate\": \"2025-07-21T00:30:52.037Z\",\r\n        \"gin\": \"405\",\r\n        \"winLevel\": \"1\"\r\n      },\r\n      {\r\n        \"winUser\": \"sl_playerDemo Player - 1468608425986\",\r\n        \"winAmount\": 2174430,\r\n        \"winDate\": \"2025-07-20T23:28:31.453Z\",\r\n        \"gin\": \"5000\",\r\n        \"winLevel\": \"0\"\r\n      },\r\n      {\r\n        \"winUser\": \"sl_playerDemo Player - 1468586610691\",\r\n        \"winAmount\": 1662702,\r\n        \"winDate\": \"2025-07-20T21:41:26.402Z\",\r\n        \"gin\": \"568\",\r\n        \"winLevel\": \"0\"\r\n      }\r\n    ],\r\n    \"topWinners\": [\r\n      {\r\n        \"winUser\": \"sl_playerDemo Player - 1445911347203\",\r\n        \"winAmount\": 3740684980,\r\n        \"winDate\": \"2025-05-17T23:51:50.2Z\",\r\n        \"gin\": \"19\",\r\n        \"winLevel\": \"3\"\r\n      },\r\n      {\r\n        \"winUser\": \"sl_playerDemo Player - 1442731278342\",\r\n        \"winAmount\": 906851261,\r\n        \"winDate\": \"2025-05-08T20:07:13.421Z\",\r\n        \"gin\": \"592\",\r\n        \"winLevel\": \"2\"\r\n      },\r\n      {\r\n        \"winUser\": \"sl_playerDemo Player - 1465539416066\",\r\n        \"winAmount\": 717453464,\r\n        \"winDate\": \"2025-07-12T06:57:44.631Z\",\r\n        \"gin\": \"529\",\r\n        \"winLevel\": \"2\"\r\n      },\r\n      {\r\n        \"winUser\": \"sl_playerDemo Player - 1453580730375\",\r\n        \"winAmount\": 638505111,\r\n        \"winDate\": \"2025-06-08T12:02:10.897Z\",\r\n        \"gin\": \"5000\",\r\n        \"winLevel\": \"2\"\r\n      },\r\n      {\r\n        \"winUser\": \"player\",\r\n        \"winAmount\": 566484756,\r\n        \"winDate\": \"2025-01-18T05:38:59.762Z\",\r\n        \"gin\": \"558\",\r\n        \"winLevel\": \"2\"\r\n      }\r\n    ]\r\n  },\r\n  \"lastWinLevelIII\": 49280491,\r\n  \"currentLevelI\": 5000,\r\n  \"winsLevelI\": 22646,\r\n  \"largestWinLevelI\": 11519320,\r\n  \"lastWinLevelI\": 1900272,\r\n  \"lastWinDateLevelI\": \"2025-07-21T06:41:19.126Z\",\r\n  \"lastWinUserLevelI\": \"sl_playerDemo Player - 1468713332737\",\r\n  \"lastWinnersLevelI\": [\r\n    {\r\n      \"winUser\": \"sl_playerDemo Player - 1468713332737\",\r\n      \"winAmount\": 1900272,\r\n      \"winDate\": \"2025-07-21T06:41:19.126Z\",\r\n      \"gin\": \"412\",\r\n      \"winLevel\": \"0\"\r\n    },\r\n    {\r\n      \"winUser\": \"sl_playerDemo Player - 1468659679233\",\r\n      \"winAmount\": 2965018,\r\n      \"winDate\": \"2025-07-21T03:19:03.992Z\",\r\n      \"gin\": \"831\",\r\n      \"winLevel\": \"0\"\r\n    },\r\n    {\r\n      \"winUser\": \"sl_playerDemo Player - 1468608425986\",\r\n      \"winAmount\": 2174430,\r\n      \"winDate\": \"2025-07-20T23:28:31.453Z\",\r\n      \"gin\": \"5000\",\r\n      \"winLevel\": \"0\"\r\n    },\r\n    {\r\n      \"winUser\": \"sl_playerDemo Player - 1468586610691\",\r\n      \"winAmount\": 1662702,\r\n      \"winDate\": \"2025-07-20T21:41:26.402Z\",\r\n      \"gin\": \"568\",\r\n      \"winLevel\": \"0\"\r\n    },\r\n    {\r\n      \"winUser\": \"sl_playerDemo Player - 1468568817666\",\r\n      \"winAmount\": 1614120,\r\n      \"winDate\": \"2025-07-20T20:20:52.879Z\",\r\n      \"gin\": \"529\",\r\n      \"winLevel\": \"0\"\r\n    }\r\n  ],\r\n  \"currentLevelII\": 6308813,\r\n  \"winsLevelII\": 7495,\r\n  \"largestWinLevelII\": 43668967,\r\n  \"lastWinLevelII\": 11460963,\r\n  \"currentLevelIII\": 126595752,\r\n  \"winsLevelIII\": 197,\r\n  \"lastWinnersLevelIII\": [\r\n    {\r\n      \"winUser\": \"sl_playerDemo Player - 1466573742082\",\r\n      \"winAmount\": 49280491,\r\n      \"winDate\": \"2025-07-15T05:05:53.468Z\",\r\n      \"gin\": \"803\",\r\n      \"winLevel\": \"2\"\r\n    },\r\n    {\r\n      \"winUser\": \"sl_playerDemo Player - 1465937166338\",\r\n      \"winAmount\": 300197160,\r\n      \"winDate\": \"2025-07-13T09:51:32.546Z\",\r\n      \"gin\": \"566\",\r\n      \"winLevel\": \"2\"\r\n    },\r\n    {\r\n      \"winUser\": \"sl_playerDemo Player - 1465539416066\",\r\n      \"winAmount\": 717453464,\r\n      \"winDate\": \"2025-07-12T06:57:44.631Z\",\r\n      \"gin\": \"529\",\r\n      \"winLevel\": \"2\"\r\n    },\r\n    {\r\n      \"winUser\": \"sl_playerDemo Player - 1454603960328\",\r\n      \"winAmount\": 296853317,\r\n      \"winDate\": \"2025-06-11T09:20:33.725Z\",\r\n      \"gin\": \"5000\",\r\n      \"winLevel\": \"2\"\r\n    },\r\n    {\r\n      \"winUser\": \"sl_playerDemo Player - 1453580730375\",\r\n      \"winAmount\": 638505111,\r\n      \"winDate\": \"2025-06-08T12:02:10.897Z\",\r\n      \"gin\": \"5000\",\r\n      \"winLevel\": \"2\"\r\n    }\r\n  ],\r\n  \"topMonthlyWinnersLevelIII\": [\r\n    {\r\n      \"winUser\": \"sl_playerDemo Player - 1465539416066\",\r\n      \"winAmount\": 717453464,\r\n      \"winDate\": \"2025-07-12T06:57:44.631Z\",\r\n      \"gin\": \"529\",\r\n      \"winLevel\": \"2\"\r\n    },\r\n    {\r\n      \"winUser\": \"sl_playerDemo Player - 1465937166338\",\r\n      \"winAmount\": 300197160,\r\n      \"winDate\": \"2025-07-13T09:51:32.546Z\",\r\n      \"gin\": \"566\",\r\n      \"winLevel\": \"2\"\r\n    },\r\n    {\r\n      \"winUser\": \"sl_playerDemo Player - 1466573742082\",\r\n      \"winAmount\": 49280491,\r\n      \"winDate\": \"2025-07-15T05:05:53.468Z\",\r\n      \"gin\": \"803\",\r\n      \"winLevel\": \"2\"\r\n    }\r\n  ],\r\n  \"largestWinDateLevelI\": \"2024-11-25T19:30:41.085Z\",\r\n  \"largestWinUserLevelI\": \"sl_playerDemo Player - 1384677064707\",\r\n  \"topMonthlyWinnersLevelI\": [\r\n    {\r\n      \"winUser\": \"sl_playerDemo Player - 1465106337793\",\r\n      \"winAmount\": 6606974,\r\n      \"winDate\": \"2025-07-11T02:30:42.021Z\",\r\n      \"gin\": \"803\",\r\n      \"winLevel\": \"0\"\r\n    },\r\n    {\r\n      \"winUser\": \"sl_playerDemo Player - 1463745466369\",\r\n      \"winAmount\": 5514700,\r\n      \"winDate\": \"2025-07-07T05:24:16.256Z\",\r\n      \"gin\": \"511\",\r\n      \"winLevel\": \"0\"\r\n    },\r\n    {\r\n      \"winUser\": \"sl_playerDemo Player - 1467365249029\",\r\n      \"winAmount\": 5391259,\r\n      \"winDate\": \"2025-07-17T10:44:46.132Z\",\r\n      \"gin\": \"566\",\r\n      \"winLevel\": \"0\"\r\n    },\r\n    {\r\n      \"winUser\": \"sl_playerDemo Player - 1466738331649\",\r\n      \"winAmount\": 5314850,\r\n      \"winDate\": \"2025-07-15T16:26:02.119Z\",\r\n      \"gin\": \"5085\",\r\n      \"winLevel\": \"0\"\r\n    },\r\n    {\r\n      \"winUser\": \"sl_playerDemo Player - 1462823956483\",\r\n      \"winAmount\": 5177801,\r\n      \"winDate\": \"2025-07-04T14:44:16.681Z\",\r\n      \"gin\": \"632\",\r\n      \"winLevel\": \"0\"\r\n    }\r\n  ],\r\n  \"topYearlyWinnersLevelI\": [\r\n    {\r\n      \"winUser\": \"sl_playerDemo Player - 1417928007683\",\r\n      \"winAmount\": 8879292,\r\n      \"winDate\": \"2025-02-27T18:42:04.828Z\",\r\n      \"gin\": \"822\",\r\n      \"winLevel\": \"0\"\r\n    },\r\n    {\r\n      \"winUser\": \"sl_playerDemo Player - 1450447736834\",\r\n      \"winAmount\": 8876067,\r\n      \"winDate\": \"2025-05-30T15:30:57.383Z\",\r\n      \"gin\": \"529\",\r\n      \"winLevel\": \"0\"\r\n    },\r\n    {\r\n      \"winUser\": \"sl_playerDemo Player - 1430054617090\",\r\n      \"winAmount\": 8266841,\r\n      \"winDate\": \"2025-04-03T00:30:59.921Z\",\r\n      \"gin\": \"529\",\r\n      \"winLevel\": \"0\"\r\n    },\r\n    {\r\n      \"winUser\": \"sl_playerDemo Player - 1434615271427\",\r\n      \"winAmount\": 7679688,\r\n      \"winDate\": \"2025-04-15T21:45:49.106Z\",\r\n      \"gin\": \"555\",\r\n      \"winLevel\": \"0\"\r\n    },\r\n    {\r\n      \"winUser\": \"sl_playerDemo Player - 1449740537857\",\r\n      \"winAmount\": 7536505,\r\n      \"winDate\": \"2025-05-28T15:28:24.044Z\",\r\n      \"gin\": \"566\",\r\n      \"winLevel\": \"0\"\r\n    }\r\n  ],\r\n  \"largestWinDateLevelII\": \"2024-11-16T12:57:21.648Z\",\r\n  \"largestWinUserLevelII\": \"player\",\r\n  \"lastWinDateLevelII\": \"2025-07-21T00:30:52.037Z\",\r\n  \"lastWinUserLevelII\": \"sl_playerDemo Player - 1468621221890\",\r\n  \"lastWinnersLevelII\": [\r\n    {\r\n      \"winUser\": \"sl_playerDemo Player - 1468621221890\",\r\n      \"winAmount\": 11460963,\r\n      \"winDate\": \"2025-07-21T00:30:52.037Z\",\r\n      \"gin\": \"405\",\r\n      \"winLevel\": \"1\"\r\n    },\r\n    {\r\n      \"winUser\": \"sl_playerDemo Player - 1468479475717\",\r\n      \"winAmount\": 6984548,\r\n      \"winDate\": \"2025-07-20T14:16:41.205Z\",\r\n      \"gin\": \"5000\",\r\n      \"winLevel\": \"1\"\r\n    },\r\n    {\r\n      \"winUser\": \"sl_playerDemo Player - 1468307861505\",\r\n      \"winAmount\": 5329605,\r\n      \"winDate\": \"2025-07-20T03:12:35.157Z\",\r\n      \"gin\": \"806\",\r\n      \"winLevel\": \"1\"\r\n    },\r\n    {\r\n      \"winUser\": \"sl_playerDemo Player - 1468248281089\",\r\n      \"winAmount\": 6338795,\r\n      \"winDate\": \"2025-07-19T22:35:52.053Z\",\r\n      \"gin\": \"5000\",\r\n      \"winLevel\": \"1\"\r\n    },\r\n    {\r\n      \"winUser\": \"sl_playerDemo Player - 1468178698245\",\r\n      \"winAmount\": 6641073,\r\n      \"winDate\": \"2025-07-19T17:56:10.674Z\",\r\n      \"gin\": \"806\",\r\n      \"winLevel\": \"1\"\r\n    }\r\n  ],\r\n  \"topMonthlyWinnersLevelII\": [\r\n    {\r\n      \"winUser\": \"sl_playerDemo Player - 1461748502534\",\r\n      \"winAmount\": 21996820,\r\n      \"winDate\": \"2025-07-01T14:16:16.985Z\",\r\n      \"gin\": \"19\",\r\n      \"winLevel\": \"1\"\r\n    },\r\n    {\r\n      \"winUser\": \"sl_playerDemo Player - 1465946402817\",\r\n      \"winAmount\": 18104927,\r\n      \"winDate\": \"2025-07-13T10:28:53.86Z\",\r\n      \"gin\": \"5082\",\r\n      \"winLevel\": \"1\"\r\n    },\r\n    {\r\n      \"winUser\": \"sl_playerDemo Player - 1465519403010\",\r\n      \"winAmount\": 14676911,\r\n      \"winDate\": \"2025-07-12T05:32:35.554Z\",\r\n      \"gin\": \"5000\",\r\n      \"winLevel\": \"1\"\r\n    },\r\n    {\r\n      \"winUser\": \"sl_playerDemo Player - 1467264069634\",\r\n      \"winAmount\": 13295559,\r\n      \"winDate\": \"2025-07-17T03:53:41.05Z\",\r\n      \"gin\": \"5085\",\r\n      \"winLevel\": \"1\"\r\n    },\r\n    {\r\n      \"winUser\": \"sl_playerDemo Player - 1462789058564\",\r\n      \"winAmount\": 12830032,\r\n      \"winDate\": \"2025-07-04T13:09:34.792Z\",\r\n      \"gin\": \"5000\",\r\n      \"winLevel\": \"1\"\r\n    }\r\n  ],\r\n  \"topYearlyWinnersLevelII\": [\r\n    {\r\n      \"winUser\": \"sl_playerDemo Player - 1412621127683\",\r\n      \"winAmount\": 32428516,\r\n      \"winDate\": \"2025-02-12T18:19:14.04Z\",\r\n      \"gin\": \"566\",\r\n      \"winLevel\": \"1\"\r\n    },\r\n    {\r\n      \"winUser\": \"sl_playerDemo Player - 1408234704903\",\r\n      \"winAmount\": 30301906,\r\n      \"winDate\": \"2025-01-31T08:53:56.454Z\",\r\n      \"gin\": \"801\",\r\n      \"winLevel\": \"1\"\r\n    },\r\n    {\r\n      \"winUser\": \"sl_playerDemo Player - 1417729564675\",\r\n      \"winAmount\": 28625973,\r\n      \"winDate\": \"2025-02-27T04:39:03.555Z\",\r\n      \"gin\": \"428\",\r\n      \"winLevel\": \"1\"\r\n    },\r\n    {\r\n      \"winUser\": \"sl_playerDemo Player - 1429524066307\",\r\n      \"winAmount\": 27434908,\r\n      \"winDate\": \"2025-04-01T13:37:01.443Z\",\r\n      \"gin\": \"527\",\r\n      \"winLevel\": \"1\"\r\n    },\r\n    {\r\n      \"winUser\": \"sl_playerDemo Player - 1417313611777\",\r\n      \"winAmount\": 26917501,\r\n      \"winDate\": \"2025-02-26T00:49:47.976Z\",\r\n      \"gin\": \"801\",\r\n      \"winLevel\": \"1\"\r\n    }\r\n  ],\r\n  \"largestWinLevelIII\": 1316734144,\r\n  \"largestWinDateLevelIII\": \"2025-01-13T19:44:49.571Z\",\r\n  \"largestWinUserLevelIII\": \"player\",\r\n  \"lastWinDateLevelIII\": \"2025-07-15T05:05:53.468Z\",\r\n  \"lastWinUserLevelIII\": \"sl_playerDemo Player - 1466573742082\",\r\n  \"currentLevelIV\": 2621389313,\r\n  \"winsLevelIV\": 14,\r\n  \"largestWinLevelIV\": 7119677079,\r\n  \"lastWinLevelIV\": 3740684980,\r\n  \"topYearlyWinnersLevelIII\": [\r\n    {\r\n      \"winUser\": \"player\",\r\n      \"winAmount\": 1316734144,\r\n      \"winDate\": \"2025-01-13T19:44:49.571Z\",\r\n      \"gin\": \"***\",\r\n      \"winLevel\": \"2\"\r\n    },\r\n    {\r\n      \"winUser\": \"sl_playerDemo Player - 1442731278342\",\r\n      \"winAmount\": 906851261,\r\n      \"winDate\": \"2025-05-08T20:07:13.421Z\",\r\n      \"gin\": \"592\",\r\n      \"winLevel\": \"2\"\r\n    },\r\n    {\r\n      \"winUser\": \"sl_playerDemo Player - 1465539416066\",\r\n      \"winAmount\": 717453464,\r\n      \"winDate\": \"2025-07-12T06:57:44.631Z\",\r\n      \"gin\": \"529\",\r\n      \"winLevel\": \"2\"\r\n    },\r\n    {\r\n      \"winUser\": \"sl_playerDemo Player - 1453580730375\",\r\n      \"winAmount\": 638505111,\r\n      \"winDate\": \"2025-06-08T12:02:10.897Z\",\r\n      \"gin\": \"5000\",\r\n      \"winLevel\": \"2\"\r\n    },\r\n    {\r\n      \"winUser\": \"player\",\r\n      \"winAmount\": 566484756,\r\n      \"winDate\": \"2025-01-18T05:38:59.762Z\",\r\n      \"gin\": \"558\",\r\n      \"winLevel\": \"2\"\r\n    }\r\n  ],\r\n  \"largestWinDateLevelIV\": \"2024-11-17T01:47:32.764Z\",\r\n  \"largestWinUserLevelIV\": \"player\",\r\n  \"lastWinDateLevelIV\": \"2025-05-17T23:51:50.2Z\",\r\n  \"lastWinUserLevelIV\": \"sl_playerDemo Player - 1445911347203\",\r\n  \"lastWinnersLevelIV\": [\r\n    {\r\n      \"winUser\": \"sl_playerDemo Player - 1445911347203\",\r\n      \"winAmount\": 3740684980,\r\n      \"winDate\": \"2025-05-17T23:51:50.2Z\",\r\n      \"gin\": \"19\",\r\n      \"winLevel\": \"3\"\r\n    },\r\n    {\r\n      \"winUser\": \"sl_playerDemo Player - 1392325828610\",\r\n      \"winAmount\": 2246048268,\r\n      \"winDate\": \"2024-12-17T09:45:13.037Z\",\r\n      \"gin\": \"***\",\r\n      \"winLevel\": \"3\"\r\n    },\r\n    {\r\n      \"winUser\": \"sl_playerDemo Player - 1384869765121\",\r\n      \"winAmount\": 2256809427,\r\n      \"winDate\": \"2024-11-26T08:31:50.579Z\",\r\n      \"gin\": \"***\",\r\n      \"winLevel\": \"3\"\r\n    },\r\n    {\r\n      \"winUser\": \"sl_playerDemo Player - 1384584265734\",\r\n      \"winAmount\": 3399684871,\r\n      \"winDate\": \"2024-11-25T12:54:59.514Z\",\r\n      \"gin\": \"***\",\r\n      \"winLevel\": \"3\"\r\n    },\r\n    {\r\n      \"winUser\": \"sl_playerDemo Player - 1383965110279\",\r\n      \"winAmount\": 2774844405,\r\n      \"winDate\": \"2024-11-23T18:45:38.703Z\",\r\n      \"gin\": \"***\",\r\n      \"winLevel\": \"3\"\r\n    }\r\n  ],\r\n  \"topMonthlyWinnersLevelIV\": [],\r\n  \"topYearlyWinnersLevelIV\": [\r\n    {\r\n      \"winUser\": \"sl_playerDemo Player - 1445911347203\",\r\n      \"winAmount\": 3740684980,\r\n      \"winDate\": \"2025-05-17T23:51:50.2Z\",\r\n      \"gin\": \"19\",\r\n      \"winLevel\": \"3\"\r\n    }\r\n  ],\r\n  \"lastWinners\": [\r\n    {\r\n      \"winUser\": \"sl_playerDemo Player - 1468713332737\",\r\n      \"winAmount\": 1900272,\r\n      \"winDate\": \"2025-07-21T06:41:19.126Z\",\r\n      \"gin\": \"412\",\r\n      \"winLevel\": \"0\"\r\n    },\r\n    {\r\n      \"winUser\": \"sl_playerDemo Player - 1468659679233\",\r\n      \"winAmount\": 2965018,\r\n      \"winDate\": \"2025-07-21T03:19:03.992Z\",\r\n      \"gin\": \"831\",\r\n      \"winLevel\": \"0\"\r\n    },\r\n    {\r\n      \"winUser\": \"sl_playerDemo Player - 1468621221890\",\r\n      \"winAmount\": 11460963,\r\n      \"winDate\": \"2025-07-21T00:30:52.037Z\",\r\n      \"gin\": \"405\",\r\n      \"winLevel\": \"1\"\r\n    },\r\n    {\r\n      \"winUser\": \"sl_playerDemo Player - 1468608425986\",\r\n      \"winAmount\": 2174430,\r\n      \"winDate\": \"2025-07-20T23:28:31.453Z\",\r\n      \"gin\": \"5000\",\r\n      \"winLevel\": \"0\"\r\n    },\r\n    {\r\n      \"winUser\": \"sl_playerDemo Player - 1468586610691\",\r\n      \"winAmount\": 1662702,\r\n      \"winDate\": \"2025-07-20T21:41:26.402Z\",\r\n      \"gin\": \"568\",\r\n      \"winLevel\": \"0\"\r\n    }\r\n  ],\r\n  \"topWinners\": [\r\n    {\r\n      \"winUser\": \"sl_playerDemo Player - 1445911347203\",\r\n      \"winAmount\": 3740684980,\r\n      \"winDate\": \"2025-05-17T23:51:50.2Z\",\r\n      \"gin\": \"19\",\r\n      \"winLevel\": \"3\"\r\n    },\r\n    {\r\n      \"winUser\": \"sl_playerDemo Player - 1442731278342\",\r\n      \"winAmount\": 906851261,\r\n      \"winDate\": \"2025-05-08T20:07:13.421Z\",\r\n      \"gin\": \"592\",\r\n      \"winLevel\": \"2\"\r\n    },\r\n    {\r\n      \"winUser\": \"sl_playerDemo Player - 1465539416066\",\r\n      \"winAmount\": 717453464,\r\n      \"winDate\": \"2025-07-12T06:57:44.631Z\",\r\n      \"gin\": \"529\",\r\n      \"winLevel\": \"2\"\r\n    },\r\n    {\r\n      \"winUser\": \"sl_playerDemo Player - 1453580730375\",\r\n      \"winAmount\": 638505111,\r\n      \"winDate\": \"2025-06-08T12:02:10.897Z\",\r\n      \"gin\": \"5000\",\r\n      \"winLevel\": \"2\"\r\n    },\r\n    {\r\n      \"winUser\": \"player\",\r\n      \"winAmount\": 566484756,\r\n      \"winDate\": \"2025-01-18T05:38:59.762Z\",\r\n      \"gin\": \"558\",\r\n      \"winLevel\": \"2\"\r\n    }\r\n  ],\r\n  \"currency\": \"FUN\",\r\n  \"timestamp\": \"2025-07-21T08:45:53.212529054Z\"\r\n}\r\n";

        private readonly ILoggingAdapter _log = Logging.GetLogger(Context);

        public WebsocketListener(Config config, IActorRef dbReader)
        {
            _dbReader       = dbReader;
            _acceptLimit    = config.GetInt("acceptlimit",  50);
            _listenURL      = config.GetString("url", "http://localhost");
            _httpListener   = new System.Net.HttpListener();
            _httpListener.Prefixes.Add(_listenURL);
            
            Receive<string>                     (processCommand);
            ReceiveAsync<HttpListenerContext>   (processIncomingConnection);
            Receive<NonWebsocketAccepted>       (_ => acceptWebsocketTask());
        }

        protected override void PreStart()
        {
            base.PreStart();
        }

        private void processCommand(string strCommand)
        {
            if (strCommand == "start")
            {
                try
                {
                    _httpListener.Start();
                    _log.Info("Starting EGT Websocket service for url {0}", _listenURL);
                }
                catch (Exception ex)
                {
                    _log.Error("Failed in starting EGT Websocket service: Exception {0}", ex.Message);
                    return;
                }

                _log.Info("Listening EGT websocket service....");
                _acceptTasks = accept().ToArray();
            }
            else if (strCommand == "stop")
            {
                _httpListener.Stop();
            }
        }

        private IEnumerable<Task> accept()
        {
            for (var i = 0; i < _acceptLimit; i++)
            {
                Task acceptTask = acceptWebsocketTask();
                yield return acceptTask;
            }
        }
        
        private async Task processIncomingConnection(HttpListenerContext context)
        {
            try
            {
                HttpListenerWebSocketContext websocketContext = await context.AcceptWebSocketAsync(null);
                IPEndPoint remoteEndPoint = context.Request.RemoteEndPoint;
                var connection          = Context.ActorOf(Props.Create(() => new WsClientConnection(websocketContext.WebSocket)));
                var connectionHandler   = Context.ActorOf(WebsocketClientHandler.Props(connection, remoteEndPoint, _dbReader));
                connection.Tell(new WsClientConnection.RegisterHandler(connectionHandler));

                _log.Info("EGT Websocket Connect request from {0}", remoteEndPoint.ToString());
            }
            catch(Exception ex)
            {
                _log.Error("Exception has been occurred in EGTWebsocketListener::processIncomingConnection {0}", (object)ex);
                context.Response.StatusCode = 500;
                context.Response.Close();
            }
            acceptWebsocketTask();
        }

        private async Task acceptWebsocketTask()
        {
            var self = Self;
            var log = _log;

            try
            {
                HttpListenerContext context = await _httpListener.GetContextAsync();

                if (context.Request.IsWebSocketRequest)
                {
                    self.Tell(context);
                }
                else
                {
                    string path = context.Request.Url.AbsolutePath.ToLower();
                    string query = context.Request.QueryString.ToString();


                    if (path == "/jackpotstats" && context.Request.HttpMethod == "GET")
                    {
                        JObject json = JObject.Parse(_jackpotstatsDummyData);
                        string timestamp = DateTime.UtcNow.ToString("yyyy-MM-ddTHH:mm:ss.fffffffZ");
                        json["timestamp"] = timestamp;
                        if (json["jackpotCards"] != null && json["jackpotCards"].Type == JTokenType.Object)
                        {
                            var jackpotCards = (JObject)json["jackpotCards"];
                            jackpotCards["timestamp"] = timestamp;
                        }
                        byte[] buffer = Encoding.UTF8.GetBytes(json.ToString());

                        context.Response.AddHeader("Access-Control-Allow-Origin", "*");
                        context.Response.ContentType = "application/json";
                        context.Response.StatusCode = 200;
                        context.Response.ContentEncoding = Encoding.UTF8;
                        context.Response.ContentLength64 = buffer.Length;

                        await context.Response.OutputStream.WriteAsync(buffer, 0, buffer.Length);
                        context.Response.Close();
                    }
                    else
                    {
                        context.Response.StatusCode = 400;
                        context.Response.Close();
                    }

                    self.Tell(new NonWebsocketAccepted());
                }
            }
            catch (Exception ex)
            {
                log.Error("Error in acceptWebsocketTask: {0}", ex);
                self.Tell(new NonWebsocketAccepted());
            }
        }

        public class NonWebsocketAccepted
        {

        }
    }
}
